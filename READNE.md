# 구현 기능

- 게시글 조회, 생성, 수정, 삭제, 목록 조회
- 댓글 조회, 생성, 삭제, 목록조회
    - 계층형
        - 최대 2depth
        - 무한 depth
- 게시글 좋아요
    - 좋아요 수
- 게시글 조회수
    - 사용자 별 10분에 1회 집계
- 인기글
    - 일 단위 상위 10건 인기글 선정
        - 매일 오전 1시 업데이트
        - 댓글수/좋아요수/조회수 기반 점수
    - 최근 N일 인기글 내역 조회



# 시스템 구성

- Spring Boot 3.3.2, Java 21, Gradle
- 멀티 모듈
    - 각 모듈은 마이크로 서비스라 가정
- article : 게시글 서비스
- comment : 댓글 서비스
- like : 좋아요 서비스
- view : 조회수 서비스
- hot-article : 인기글 서비스
- article-read : 게시글 조회 서비스

### Kafka 활용 EDA 구성 

**Transactional Messaging을 위해 OutBox 패턴 적용**

**Message Broker**
- 게시글/좋아요/조회수/댓글 서비스의 데이터 변경이 생기면
    - 메시지 브로커로 이벤트 전송하고, 인기글 서비스에서 이벤트를 가져와서 처리
- 복잡한 구현
    - 대규모 데이터를 안전하게 처리하기 위한 시스템 필요할 수도 있음.
- 타 서비스에 메시지 브로커 이용한 간접적 의존성, 시스템 간 결합도 감소
- 서버 부하 전파
    - 인기글
        - 인기글 서비스는 메시지 브로커에서
        - 적절히 이벤트를 가져와서 비동기 처리 가능
    - 게시글/좋아요/조회수/댓글
    - 장애 전파, 유실 등의 위험 낮음


### 아이디 생성 방식

**SnowFlake**
- 분산 시스템에서 고유한 오름차수을 위해 고안된 알고리즘
- 충돌 확률이 완전히 0은 아니지만, 생성 시간(created_at) 보다 충돌 가능성이 현저히 작다.
- 오름차순이기 때문에 생성 시간에 의해 정렬된 상태를 가지고 있다

**필요성**
- 동시 요청시에 생성 시간은 충돌될 수 있다.
- create_at를 정렬 조건으로 사용한다면, 동일한 생성시간 간에 순서가 명확하지 않다.
    - 목록 조회에 대한 결과값이 달라질 수 있다.
    - 데이터의 중복 또는 누락 가능성
- 밀리/나노초 단위의 더욱 정밀한 타입을 가진다고 해도,  확률은 줄어들지만 시간 충돌 문제는 여전하고 저장 공간만 더 필요해질 수 있다.



# 게시글 목록 조회
- non offset pagination 방식 사용, offset이 많아질수록 성능이 감소하는 이슈 고려
- MySQL의 clustered index 특성을 활용 커버링인덱스를 적용한 쿼리를 사용하여 조회 성능 향상


# 댓글 구현
- path에 인덱스를 생성하여 정렬 데이터를 관리.
- path는 독립적인 경로를 가지므로, unique index로 생성.
    - 애플리케이션에서의 동시성 문제를 방지.


# 좋아요
- 동시성 문제 고려 비관적락, 낙관적 락 2가지 방식 고려


# 조회수
- 조회수는 데이터의 일관성이 크게 중요하지 않고 트래픽이 아주 많다는 점을 고려
- In-memory database Redis 사용
- 어뷰징 방지를 위해 분산락, TTL 적용


# 인기글
- 게시글에 대한 이벤트를 수집하여 Score를 계산하여 Redis에 저장
- 일단위 인기글 제공을 위해 TTL 활용
- Redis의 SortedSet을 사용하여 상위 10개의 게시글을 조회
- Transactional Messaging을 위하여 Transactional Outbox 패턴을 사용


# 단건 조회 최적화
- 쓰기 트래보다 읽기 트래픽이 압도적 고려 
- CQRS 패턴 적용
- 게시글 조회 서비스를 따로 분리
- 분산 데이터를 조합하여 질의 해야 하기 때문에 조회 최적화를 위해 비정규화된 Query모델 사용
- 최신글이 조회되는 경우가 많기 때문에 Redis에 TTL(1일) 설정하여 최신글 캐싱 적용

# 게시글 목록 조회 최적화
- 1000개의 게시글에 대한 hot data(최신글) Redis 캐싱
- 캐시 갱신에 대한 원본데이터 접근을 줄이기 위해서 분산락 적용
    - Logical TTL과 Physical TTL을 다르게 가져가는 전략 사용